<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Crea tu Tour - Viaja a Loja</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet">
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <link href="https://cdnjs.cloudflare.com/ajax/libs/aos/2.3.4/aos.css" rel="stylesheet">
  <style>
    :root {
      --primary-color: #2E7D32;
      --secondary-color: #FFA726;
      --accent-color: #00ACC1;
    }
    
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      padding-top: 76px;
    }
    
    .navbar-brand {
      font-weight: bold;
      font-size: 1.5rem;
    }
    
    .hero-banner {
      background: linear-gradient(135deg, var(--primary-color) 0%, var(--accent-color) 100%);
      color: white;
      padding: 3rem 0;
      margin-bottom: 2rem;
    }
    
    #map {
      height: 500px;
      border-radius: 15px;
      box-shadow: 0 8px 25px rgba(0,0,0,0.15);
      border: 3px solid #e9ecef;
    }
    
    .selection-card {
      background: linear-gradient(145deg, #ffffff 0%, #f8f9fa 100%);
      border: none;
      border-radius: 15px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
      transition: all 0.3s ease;
      padding: 1.5rem;
      margin-bottom: 1rem;
    }
    
    .selection-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 8px 25px rgba(0,0,0,0.15);
    }
    
    .plan-card {
      background: linear-gradient(145deg, #e8f5e8 0%, #f1f8e9 100%);
      border: 2px solid var(--primary-color);
      border-radius: 15px;
      padding: 2rem;
      position: sticky;
      top: 100px;
    }
    
    .activity-item {
      background: white;
      border: 1px solid #e9ecef;
      border-radius: 10px;
      padding: 1rem;
      margin-bottom: 0.5rem;
      display: flex;
      justify-content: between;
      align-items: center;
      transition: all 0.3s ease;
    }
    
    .activity-item:hover {
      background: #f8f9fa;
      border-color: var(--primary-color);
    }
    
    .activity-item .remove-btn {
      color: #dc3545;
      cursor: pointer;
      font-size: 1.2rem;
    }
    
    .activity-item .remove-btn:hover {
      color: #a02834;
    }
    
    .price-tag {
      background: var(--secondary-color);
      color: white;
      padding: 0.25rem 0.75rem;
      border-radius: 20px;
      font-weight: bold;
      font-size: 0.9rem;
    }
    
    .city-badge {
      background: var(--primary-color);
      color: white;
      padding: 0.25rem 0.5rem;
      border-radius: 15px;
      font-size: 0.8rem;
      margin-left: 0.5rem;
    }
    
    .btn-custom {
      border-radius: 25px;
      padding: 10px 25px;
      font-weight: 500;
      transition: all 0.3s ease;
    }
    
    .form-select, .form-control {
      border-radius: 10px;
      border: 2px solid #e9ecef;
      transition: all 0.3s ease;
    }
    
    .form-select:focus, .form-control:focus {
      border-color: var(--primary-color);
      box-shadow: 0 0 0 0.2rem rgba(46, 125, 50, 0.25);
    }
    
    .weather-widget {
      background: linear-gradient(135deg, #74b9ff 0%, #0984e3 100%);
      color: white;
      border-radius: 15px;
      padding: 1.5rem;
      text-align: center;
    }
    
    .progress-bar-custom {
      height: 8px;
      border-radius: 4px;
      background: #e9ecef;
      margin: 1rem 0;
    }
    
    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--primary-color) 0%, var(--accent-color) 100%);
      border-radius: 4px;
      transition: width 0.3s ease;
    }
    
    .map-controls {
      position: absolute;
      top: 10px;
      right: 10px;
      z-index: 1000;
      display: flex;
      flex-direction: column;
      gap: 5px;
    }
    
    .map-control-btn {
      background: white;
      border: 2px solid #ddd;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    
    .map-control-btn:hover {
      background: var(--primary-color);
      color: white;
      border-color: var(--primary-color);
    }
    
    .notification-toast {
      position: fixed;
      top: 100px;
      right: 20px;
      z-index: 1050;
      min-width: 250px;
    }
    
    @keyframes slideInRight {
      from {
        transform: translateX(100%);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }
    
    .slide-in {
      animation: slideInRight 0.3s ease;
    }
    
    .leaflet-popup-content-wrapper {
      border-radius: 10px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.2);
    }
    
    .custom-marker {
      background: var(--primary-color);
      border: 3px solid white;
      border-radius: 50%;
      box-shadow: 0 2px 8px rgba(0,0,0,0.3);
    }
  </style>
</head>
<body>
  <!-- Toast de notificaciones -->
  <div id="notification-container" class="notification-toast"></div>

  <!-- Navegaci√≥n -->
  <nav class="navbar navbar-expand-lg navbar-dark bg-dark fixed-top shadow">
    <div class="container">
      <a class="navbar-brand" href="./index.html">
        <i class="bi bi-compass"></i> Viaja a Loja
      </a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav ms-auto">
          <li class="nav-item">
            <a class="nav-link" href="./index.html">
              <i class="bi bi-house"></i> Inicio
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="./perfil.html">
              <i class="bi bi-person"></i> Mi Perfil
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link active" href="./crea-tu-tour.html">
              <i class="bi bi-map"></i> Crea tu Tour
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="./pasaporte.html">
              <i class="bi bi-award"></i> Pasaporte
            </a>
          </li>
        </ul>
      </div>
    </div>
  </nav>

  <!-- Hero Banner -->
  <section class="hero-banner">
    <div class="container">
      <div class="row align-items-center">
        <div class="col-md-8">
          <h1 class="display-5 fw-bold mb-3">
            <i class="bi bi-map-fill"></i> Crea tu Tour Personalizado
          </h1>
          <p class="lead mb-0">Dise√±a la experiencia perfecta combinando destinos, actividades y servicios seg√∫n tus gustos</p>
        </div>
        <div class="col-md-4 text-md-end">
          <div class="weather-widget" data-aos="fade-left">
            <div class="d-flex align-items-center justify-content-center">
              <i class="bi bi-sun-fill fs-2 me-3"></i>
              <div>
                <h4 class="mb-0">24¬∞C</h4>
                <small>Loja - Soleado</small>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <div class="container py-4">
    <div class="row">
      <!-- Panel Izquierdo - Mapa y Controles -->
      <div class="col-lg-8 mb-4">
        <!-- Progreso del tour -->
        <div class="selection-card mb-4" data-aos="fade-up">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <h6 class="mb-0">Progreso de tu tour</h6>
            <span class="badge bg-primary" id="progress-text">0/10 actividades</span>
          </div>
          <div class="progress-bar-custom">
            <div class="progress-fill" id="progress-fill" style="width: 0%"></div>
          </div>
        </div>

        <!-- Mapa Interactivo -->
        <div class="selection-card" data-aos="fade-up" data-aos-delay="100">
          <h3 class="mb-3">
            <i class="bi bi-geo-alt-fill text-primary"></i> Explora el Mapa
          </h3>
          <div class="position-relative">
            <div id="map"></div>
            <div class="map-controls">
              <button class="map-control-btn" id="centerMap" title="Centrar mapa">
                <i class="bi bi-crosshair"></i>
              </button>
              <button class="map-control-btn" id="fullscreen" title="Pantalla completa">
                <i class="bi bi-arrows-fullscreen"></i>
              </button>
              <button class="map-control-btn" id="locate" title="Mi ubicaci√≥n">
                <i class="bi bi-geo-alt"></i>
              </button>
            </div>
          </div>
        </div>

        <!-- Selecciones -->
        <div class="selection-card mt-4" data-aos="fade-up" data-aos-delay="200">
          <h3 class="mb-4">
            <i class="bi bi-list-check text-success"></i> Personaliza tu Experiencia
          </h3>
          <div class="row g-3">
            <div class="col-md-6">
              <label for="ciudadSelect" class="form-label fw-bold">
                <i class="bi bi-building"></i> Ciudad
              </label>
              <select class="form-select" id="ciudadSelect">
                <option value="" selected disabled>Selecciona una ciudad...</option>
                <option value="loja">üèõÔ∏è Loja (Ciudad Capital)</option>
                <option value="vilcabamba">üåø Vilcabamba (Valle de la Longevidad)</option>
                <option value="saraguro">üé≠ Saraguro (Cultura Ancestral)</option>
                <option value="catamayo">‚òÄÔ∏è Catamayo (Tierra C√°lida)</option>
                <option value="zamora">ü¶ã Zamora (Biodiversidad)</option>
              </select>
            </div>
            <div class="col-md-6">
              <label for="actividadSelect" class="form-label fw-bold">
                <i class="bi bi-activity"></i> Actividad
              </label>
              <select class="form-select" id="actividadSelect" disabled>
                <option value="" selected>Primero selecciona una ciudad</option>
              </select>
            </div>
          </div>
          
          <div class="mt-4 p-3 bg-light rounded-3" id="seleccionResumen">
            <div class="text-center text-muted">
              <i class="bi bi-arrow-up-circle fs-2 mb-2"></i>
              <p class="mb-0">Selecciona una ciudad y actividad para comenzar</p>
            </div>
          </div>
          
          <div class="text-center mt-3">
            <button id="agregarPlanBtn" class="btn btn-primary btn-custom" disabled>
              <i class="bi bi-plus-circle"></i> Agregar al Plan
            </button>
          </div>
        </div>
      </div>

      <!-- Panel Derecho - Plan de Viaje -->
      <div class="col-lg-4">
        <div class="plan-card" data-aos="fade-up" data-aos-delay="300">
          <h3 class="text-center mb-4">
            <i class="bi bi-calendar-check text-primary"></i> Tu Plan de Viaje
          </h3>
          
          <div id="planVacio" class="text-center py-4">
            <i class="bi bi-calendar-x fs-1 text-muted mb-3"></i>
            <p class="text-muted">Tu plan est√° vac√≠o</p>
            <small class="text-muted">Agrega actividades para comenzar tu aventura</small>
          </div>
          
          <div id="planContenido" style="display: none;">
            <div class="mb-3">
              <h6 class="text-muted mb-2">ACTIVIDADES SELECCIONADAS</h6>
              <div id="planLista"></div>
            </div>
            
            <hr>
            
            <div class="d-flex justify-content-between align-items-center mb-3">
              <span class="fw-bold">Total Estimado:</span>
              <span class="h4 text-primary mb-0" id="totalPrice">$0</span>
            </div>
            
            <div class="mb-3">
              <small class="text-muted">
                <i class="bi bi-info-circle"></i> 
                Incluye gu√≠a, transporte y entradas
              </small>
            </div>
            
            <div class="d-grid gap-2">
              <button id="pagarBtn" class="btn btn-success btn-custom" data-bs-toggle="modal" data-bs-target="#resumenPagoModal">
                <i class="bi bi-credit-card"></i> Proceder al Pago
              </button>
              <button id="guardarBtn" class="btn btn-outline-primary btn-custom">
                <i class="bi bi-bookmark"></i> Guardar para Despu√©s
              </button>
              <button id="limpiarBtn" class="btn btn-outline-danger btn-custom">
                <i class="bi bi-trash"></i> Limpiar Plan
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal de Resumen de Pago Mejorado -->
  <div class="modal fade" id="resumenPagoModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header bg-primary text-white">
          <h5 class="modal-title">
            <i class="bi bi-receipt"></i> Resumen de tu Reserva
          </h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body p-4">
          <div class="row">
            <div class="col-md-8">
              <h6 class="text-muted mb-3">DETALLES DEL TOUR</h6>
              <div id="resumenPagoBody"></div>
            </div>
            <div class="col-md-4">
              <div class="bg-light p-3 rounded-3">
                <h6 class="mb-3">Informaci√≥n de Contacto</h6>
                <div class="mb-2">
                  <label for="nombreReserva" class="form-label">Nombre Completo</label>
                  <input type="text" class="form-control" id="nombreReserva" required>
                </div>
                <div class="mb-2">
                  <label for="emailReserva" class="form-label">Email</label>
                  <input type="email" class="form-control" id="emailReserva" required>
                </div>
                <div class="mb-3">
                  <label for="telefonoReserva" class="form-label">Tel√©fono</label>
                  <input type="tel" class="form-control" id="telefonoReserva" required>
                </div>
                <div class="form-check mb-3">
                  <input class="form-check-input" type="checkbox" id="terminos" required>
                  <label class="form-check-label" for="terminos">
                    <small>Acepto t√©rminos y condiciones</small>
                  </label>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="modal-footer bg-light">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
            <i class="bi bi-x-circle"></i> Cancelar
          </button>
          <button type="button" class="btn btn-success btn-custom" id="confirmarPagoBtn">
            <i class="bi bi-check-circle"></i> Confirmar Reserva
          </button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/aos/2.3.4/aos.js"></script>
  <script>
    // Inicializar AOS
    AOS.init({ duration: 800, once: true });

    // Coordenadas y datos mejorados
    const ciudadesCoords = {
      loja: { lat: -4.0075952, lng: -79.20837875, zoom: 13, radio: 3000 },
      vilcabamba: { lat: -4.2625, lng: -79.2222, zoom: 13, radio: 2000 },
      saraguro: { lat: -3.6197, lng: -79.2333, zoom: 13, radio: 2000 },
      catamayo: { lat: -4.0833, lng: -79.3667, zoom: 13, radio: 2500 },
      zamora: { lat: -4.0667, lng: -78.9500, zoom: 13, radio: 2000 }
    };

    const actividadesCoords = {
      loja: [
        { nombre: "Catedral y centro hist√≥rico", lat: -4.007, lng: -79.208, icono: "üèõÔ∏è" },
        { nombre: "Parque Jipiro (tem√°tico)", lat: -4.000, lng: -79.210, icono: "üé†" },
        { nombre: "Puerta de la Ciudad", lat: -4.013, lng: -79.205, icono: "üè∞" },
        { nombre: "Museos y centros culturales", lat: -4.008, lng: -79.209, icono: "üé®" },
        { nombre: "M√∫sica y eventos tradicionales", lat: -4.007, lng: -79.208, icono: "üéµ" }
      ],
      vilcabamba: [
        { nombre: "Valle de la Longevidad", lat: -4.262, lng: -79.222, icono: "üåÑ" },
        { nombre: "Turismo de naturaleza y bienestar", lat: -4.265, lng: -79.225, icono: "üßò" },
        { nombre: "Senderos y caminatas", lat: -4.260, lng: -79.220, icono: "ü•æ" }
      ],
      saraguro: [
        { nombre: "Cultura ind√≠gena Saraguro viva", lat: -3.619, lng: -79.233, icono: "üë•" },
        { nombre: "Gastronom√≠a t√≠pica andina", lat: -3.620, lng: -79.234, icono: "üçΩÔ∏è" },
        { nombre: "Talleres de tejidos ancestrales", lat: -3.618, lng: -79.232, icono: "üß∂" }
      ],
      catamayo: [
        { nombre: "Clima c√°lido seco", lat: -4.083, lng: -79.367, icono: "‚òÄÔ∏è" },
        { nombre: "Balnearios naturales", lat: -4.080, lng: -79.360, icono: "üèä" },
        { nombre: "Centro hist√≥rico", lat: -4.085, lng: -79.365, icono: "üèõÔ∏è" }
      ],
      zamora: [
        { nombre: "Parque Nacional Podocarpus", lat: -4.067, lng: -78.950, icono: "üå≤" },
        { nombre: "Observaci√≥n de aves", lat: -4.065, lng: -78.945, icono: "ü¶Ö" },
        { nombre: "Ecoturismo", lat: -4.070, lng: -78.955, icono: "üåø" }
      ]
    };

    const actividades = {
      loja: [
        "Catedral y centro hist√≥rico",
        "Parque Jipiro (tem√°tico)", 
        "Puerta de la Ciudad",
        "Museos y centros culturales",
        "M√∫sica y eventos tradicionales"
      ],
      vilcabamba: [
        "Valle de la Longevidad",
        "Turismo de naturaleza y bienestar",
        "Senderos y caminatas"
      ],
      saraguro: [
        "Cultura ind√≠gena Saraguro viva",
        "Gastronom√≠a t√≠pica andina", 
        "Talleres de tejidos ancestrales"
      ],
      catamayo: [
        "Clima c√°lido seco",
        "Balnearios naturales",
        "Centro hist√≥rico"
      ],
      zamora: [
        "Parque Nacional Podocarpus",
        "Observaci√≥n de aves",
        "Ecoturismo"
      ]
    };

    const preciosActividades = {
      "Catedral y centro hist√≥rico": 12,
      "Parque Jipiro (tem√°tico)": 15,
      "Puerta de la Ciudad": 8,
      "Museos y centros culturales": 10,
      "M√∫sica y eventos tradicionales": 20,
      "Valle de la Longevidad": 25,
      "Turismo de naturaleza y bienestar": 30,
      "Senderos y caminatas": 18,
      "Cultura ind√≠gena Saraguro viva": 22,
      "Gastronom√≠a t√≠pica andina": 16,
      "Talleres de tejidos ancestrales": 28,
      "Clima c√°lido seco": 12,
      "Balnearios naturales": 20,
      "Centro hist√≥rico": 10,
      "Parque Nacional Podocarpus": 35,
      "Observaci√≥n de aves": 40,
      "Ecoturismo": 32
    };

    // Inicializar mapa
    const map = L.map('map').setView([ciudadesCoords.loja.lat, ciudadesCoords.loja.lng], ciudadesCoords.loja.zoom);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    // Variables globales
    let ciudadCircle;
    let actividadMarkers = [];
    let plan = [];
    
    // Elementos DOM
    const ciudadSelect = document.getElementById('ciudadSelect');
    const actividadSelect = document.getElementById('actividadSelect'); 
    const seleccionResumen = document.getElementById('seleccionResumen');
    const agregarPlanBtn = document.getElementById('agregarPlanBtn');
    const planLista = document.getElementById('planLista');
    const planVacio = document.getElementById('planVacio');
    const planContenido = document.getElementById('planContenido');
    const totalPrice = document.getElementById('totalPrice');
    const progressFill = document.getElementById('progress-fill');
    const progressText = document.getElementById('progress-text');

    // Funci√≥n para mostrar notificaciones
    function showNotification(message, type = 'success') {
      const toast = document.createElement('div');
      toast.className = `toast align-items-center text-white bg-${type} border-0 slide-in`;
      toast.setAttribute('role', 'alert');
      toast.innerHTML = `
        <div class="d-flex">
          <div class="toast-body">
            <i class="bi bi-${type === 'success' ? 'check-circle' : 'exclamation-triangle'} me-2"></i>
            ${message}
          </div>
          <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
        </div>
      `;
      
      document.getElementById('notification-container').appendChild(toast);
      const bsToast = new bootstrap.Toast(toast);
      bsToast.show();
      
      setTimeout(() => {
        toast.remove();
      }, 5000);
    }

    // Actualizar progreso
    function updateProgress() {
      const progress = Math.min((plan.length / 10) * 100, 100);
      progressFill.style.width = progress + '%';
      progressText.textContent = `${plan.length}/10 actividades`;
    }

    // Actualizar plan visual
    function updatePlanDisplay() {
      if (plan.length === 0) {
        planVacio.style.display = 'block';
        planContenido.style.display = 'none';
        return;
      }

      planVacio.style.display = 'none';
      planContenido.style.display = 'block';
      
      planLista.innerHTML = '';
      let total = 0;

      plan.forEach((item, index) => {
        const precio = preciosActividades[item.actividad] || 15;
        total += precio;
        
        const activityDiv = document.createElement('div');
        activityDiv.className = 'activity-item';
        activityDiv.innerHTML = `
          <div class="flex-grow-1">
            <div class="fw-bold">${item.actividad}</div>
            <small class="text-muted">
              <i class="bi bi-geo-alt"></i> ${item.ciudad}
              <span class="city-badge">${item.ciudad}</span>
            </small>
          </div>
          <div class="d-flex align-items-center gap-2">
            <span class="price-tag">${precio}</span>
            <i class="bi bi-x-circle remove-btn" onclick="removeFromPlan(${index})" title="Eliminar"></i>
          </div>
        `;
        planLista.appendChild(activityDiv);
      });

      totalPrice.textContent = `${total}`;
      updateProgress();
    }

    // Eliminar del plan
    function removeFromPlan(index) {
      plan.splice(index, 1);
      updatePlanDisplay();
      showNotification('Actividad eliminada del plan', 'warning');
    }

    // Event listeners
    ciudadSelect.addEventListener('change', function() {
      const ciudad = this.value;
      
      if (ciudadesCoords[ciudad]) {
        map.setView([ciudadesCoords[ciudad].lat, ciudadesCoords[ciudad].lng], ciudadesCoords[ciudad].zoom);

        // Remover c√≠rculo anterior
        if (ciudadCircle) {
          map.removeLayer(ciudadCircle);
        }
        
        // Nuevo c√≠rculo
        ciudadCircle = L.circle([ciudadesCoords[ciudad].lat, ciudadesCoords[ciudad].lng], {
          color: '#2E7D32',
          fillColor: '#4CAF50',
          fillOpacity: 0.2,
          radius: ciudadesCoords[ciudad].radio
        }).addTo(map);
      }

      // Limpiar marcadores
      actividadMarkers.forEach(m => map.removeLayer(m));
      actividadMarkers = [];

      // Nuevos marcadores
      if (actividadesCoords[ciudad]) {
        actividadesCoords[ciudad].forEach(act => {
          const marker = L.marker([act.lat, act.lng]).addTo(map);
          
          const popupContent = `
            <div class="text-center">
              <div style="font-size: 2rem; margin-bottom: 0.5rem;">${act.icono}</div>
              <strong>${act.nombre}</strong><br>
              <small class="text-muted">${ciudadSelect.options[ciudadSelect.selectedIndex].text}</small><br>
              <button class="btn btn-sm btn-primary mt-2" onclick="selectFromMap('${act.nombre}')">
                <i class="bi bi-plus"></i> Seleccionar
              </button>
            </div>
          `;
          
          marker.bindPopup(popupContent);
          actividadMarkers.push(marker);
        });
      }

      // Actualizar select de actividades
      actividadSelect.innerHTML = '';
      if (ciudad && actividades[ciudad]) {
        actividadSelect.disabled = false;
        actividadSelect.innerHTML = '<option value="" selected disabled>Elige una actividad...</option>';
        actividades[ciudad].forEach(act => {
          const opt = document.createElement('option');
          opt.value = act;
          opt.textContent = act;
          actividadSelect.appendChild(opt);
        });
      } else {
        actividadSelect.disabled = true;
        actividadSelect.innerHTML = '<option value="" selected>Primero selecciona una ciudad</option>';
      }
      
      resetSelection();
    });

    actividadSelect.addEventListener('change', function() {
      updateSelectionDisplay();
    });

    function updateSelectionDisplay() {
      const ciudad = ciudadSelect.options[ciudadSelect.selectedIndex]?.text || '';
      const actividad = actividadSelect.value;
      const precio = preciosActividades[actividad] || 15;
      
      if (ciudad && actividad) {
        seleccionResumen.innerHTML = `
          <div class="d-flex align-items-center justify-content-between">
            <div>
              <h6 class="mb-1"><i class="bi bi-check-circle text-success"></i> Selecci√≥n Actual</h6>
              <strong>${actividad}</strong><br>
              <small class="text-muted"><i class="bi bi-geo-alt"></i> ${ciudad}</small>
            </div>
            <div class="text-end">
              <div class="price-tag">${precio}</div>
              <small class="text-muted d-block mt-1">por persona</small>
            </div>
          </div>
        `;
        agregarPlanBtn.disabled = false;
      } else {
        resetSelection();
      }
    }

    function resetSelection() {
      seleccionResumen.innerHTML = `
        <div class="text-center text-muted">
          <i class="bi bi-arrow-up-circle fs-2 mb-2"></i>
          <p class="mb-0">Selecciona una ciudad y actividad para comenzar</p>
        </div>
      `;
      agregarPlanBtn.disabled = true;
    }

    function selectFromMap(nombreActividad) {
      actividadSelect.value = nombreActividad;
      updateSelectionDisplay();
      showNotification('Actividad seleccionada desde el mapa');
    }

    // Agregar al plan
    agregarPlanBtn.addEventListener('click', function() {
      const ciudad = ciudadSelect.options[ciudadSelect.selectedIndex].text;
      const actividad = actividadSelect.value;
      
      // Verificar si ya est√° en el plan
      const yaExiste = plan.some(item => 
        item.actividad === actividad && item.ciudad === ciudad
      );
      
      if (yaExiste) {
        showNotification('Esta actividad ya est√° en tu plan', 'warning');
        return;
      }
      
      if (plan.length >= 10) {
        showNotification('M√°ximo 10 actividades por tour', 'warning');
        return;
      }
      
      if (ciudad && actividad) {
        plan.push({ ciudad, actividad });
        updatePlanDisplay();
        resetSelection();
        actividadSelect.value = '';
        showNotification(`${actividad} agregada a tu plan`);
      }
    });

    // Botones adicionales
    document.getElementById('limpiarBtn').addEventListener('click', function() {
      if (plan.length === 0) return;
      
      if (confirm('¬øEst√°s seguro de que quieres limpiar todo el plan?')) {
        plan = [];
        updatePlanDisplay();
        showNotification('Plan limpiado', 'warning');
      }
    });

    document.getElementById('guardarBtn').addEventListener('click', function() {
      if (plan.length === 0) {
        showNotification('No hay nada que guardar', 'warning');
        return;
      }
      
      localStorage.setItem('tourGuardado', JSON.stringify(plan));
      showNotification('Plan guardado exitosamente');
    });

    // Controles del mapa
    document.getElementById('centerMap').addEventListener('click', function() {
      const ciudad = ciudadSelect.value || 'loja';
      map.setView([ciudadesCoords[ciudad].lat, ciudadesCoords[ciudad].lng], ciudadesCoords[ciudad].zoom);
    });

    document.getElementById('fullscreen').addEventListener('click', function() {
      const mapContainer = document.getElementById('map');
      if (mapContainer.requestFullscreen) {
        mapContainer.requestFullscreen();
      }
    });

    document.getElementById('locate').addEventListener('click', function() {
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(function(position) {
          const lat = position.coords.latitude;
          const lng = position.coords.longitude;
          map.setView([lat, lng], 15);
          
          L.marker([lat, lng])
            .addTo(map)
            .bindPopup('Tu ubicaci√≥n actual')
            .openPopup();
            
          showNotification('Ubicaci√≥n encontrada');
        }, function() {
          showNotification('No se pudo obtener la ubicaci√≥n', 'warning');
        });
      } else {
        showNotification('Geolocalizaci√≥n no soportada', 'warning');
      }
    });

    // Modal de pago
    document.getElementById('pagarBtn').addEventListener('click', function() {
      if (plan.length === 0) {
        showNotification('Agrega actividades antes de proceder al pago', 'warning');
        return;
      }
      
      let total = 0;
      let tabla = `
        <div class="table-responsive">
          <table class="table table-hover">
            <thead class="table-light">
              <tr>
                <th>Actividad</th>
                <th>Ciudad</th>
                <th>Precio</th>
              </tr>
            </thead>
            <tbody>
      `;
      
      plan.forEach(item => {
        const precio = preciosActividades[item.actividad] || 15;
        total += precio;
        tabla += `
          <tr>
            <td>
              <strong>${item.actividad}</strong><br>
              <small class="text-muted">Incluye gu√≠a y transporte</small>
            </td>
            <td>
              <span class="badge bg-secondary">${item.ciudad}</span>
            </td>
            <td class="text-end">
              <strong>${precio}</strong>
            </td>
          </tr>
        `;
      });
      
      tabla += `
            </tbody>
            <tfoot class="table-light">
              <tr>
                <th colspan="2">Total</th>
                <th class="text-end h5 text-primary">${total}</th>
              </tr>
            </tfoot>
          </table>
        </div>
        
        <div class="alert alert-info mt-3">
          <i class="bi bi-info-circle me-2"></i>
          <strong>El tour incluye:</strong> Gu√≠a profesional, transporte, entradas y seguro b√°sico.
        </div>
      `;
      
      document.getElementById('resumenPagoBody').innerHTML = tabla;
    });

    document.getElementById('confirmarPagoBtn').addEventListener('click', function() {
      const nombre = document.getElementById('nombreReserva').value;
      const email = document.getElementById('emailReserva').value;
      const telefono = document.getElementById('telefonoReserva').value;
      const terminos = document.getElementById('terminos').checked;
      
      if (!nombre || !email || !telefono || !terminos) {
        showNotification('Por favor completa todos los campos', 'warning');
        return;
      }
      
      // Simular procesamiento
      this.disabled = true;
      this.innerHTML = '<i class="bi bi-hourglass-split"></i> Procesando...';
      
      setTimeout(() => {
        const modal = bootstrap.Modal.getInstance(document.getElementById('resumenPagoModal'));
        modal.hide();
        
        showNotification('¬°Reserva confirmada! Te contactaremos pronto');
        
        // Limpiar plan despu√©s de confirmar
        plan = [];
        updatePlanDisplay();
        
        // Reset bot√≥n
        this.disabled = false;
        this.innerHTML = '<i class="bi bi-check-circle"></i> Confirmar Reserva';
        
        // Limpiar formulario
        document.getElementById('nombreReserva').value = '';
        document.getElementById('emailReserva').value = '';
        document.getElementById('telefonoReserva').value = '';
        document.getElementById('terminos').checked = false;
        
      }, 2000);
    });

    // Cargar plan guardado al inicio
    window.addEventListener('load', function() {
      const planGuardado = localStorage.getItem('tourGuardado');
      if (planGuardado) {
        try {
          plan = JSON.parse(planGuardado);
          updatePlanDisplay();
          if (plan.length > 0) {
            showNotification('Plan guardado cargado exitosamente');
          }
        } catch (e) {
          console.error('Error cargando plan guardado:', e);
        }
      }
      
      // Inicializar con Loja
      ciudadSelect.value = 'loja';
      ciudadSelect.dispatchEvent(new Event('change'));
    });

    // Hacer funci√≥n global para uso en popups
    window.selectFromMap = selectFromMap;
    window.removeFromPlan = removeFromPlan;
  </script>
</body>
</html>